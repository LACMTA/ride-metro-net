---
import { openDb, type Stop } from "gtfs";
import Layout from "../../layouts/Layout.astro";
import { GTFSconfig } from "../../integrations/import-gtfs";
import DataInjector from "../../components/DataInjector.astro";
import getStopWithRoutes from "../../lib/getStopWithRoutes";
import StopRoutePrediction from "../../components/StopRoutePrediction";
import AlertList from "../../components/AlertList";

export const prerender = true;

export async function getStaticPaths() {
  const db = openDb(GTFSconfig);
  // TODO: this will currently build all pages. Consider building only pages for pilot.
  const allStops = (await db
    .prepare("SELECT DISTINCT stop_id FROM stops")
    .all()) as { stop_id: string }[];

  return allStops.map((stop) => ({
    params: { stopId: stop.stop_id },
  }));
}

const { stopId } = Astro.params;

const stop = await getStopWithRoutes(stopId);
---

<DataInjector data={stop} id="data-stop" />
<script>
  import { getData } from "../../lib/getData";
  import type { StopWithRoutes } from "../../lib/getStopWithRoutes";
  import watchAlerts from "../../lib/watchAlerts";
  import watchPredictions from "../../lib/watchPredictions";

  const stop = getData("data-stop") as StopWithRoutes;

  console.log("Pre-build GTFS data:", stop);
  watchAlerts(
    [stop.stopId],
    stop.routes.map((route) => route.routeId),
  );
  watchPredictions(stop.stopId);
</script>

<Layout title={stop.stopName}>
  <ul>{stop.routes.map((route) => <li>{route.routeShortName}</li>)}</ul>
  <main>
    <h1>{stop.stopName}</h1>
    <small>STOP ID: <b>{stop.stopId}</b></small>
    <AlertList stopIds={[stop.stopId]} alertEntityType="stop" client:load />
    <ul>
      {
        stop.routes.map((route) => (
          <StopRoutePrediction route={route} client:load />
        ))
      }
    </ul>
  </main>
</Layout>
